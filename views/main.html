{% extends 'layout.html' %}

{% block login %}
  <div class="login-block">
        {% if user and user.id%}
          {% if user.popup==0 %}
            <div id="nick-modal" class="modal" style="display:block;">
              <div class="modal-content">
                <span class="modal-close" onclick="popupClose();">&times;</span>                                                               
                <p>ğŸ“Œ ë‹‰ë„¤ì„ì€ ë‚´ í”„ë¡œí•„ì—ì„œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <a href="/profile">ë‚´ í”„ë¡œí•„ê°€ê¸°</a><br>
                <input type="radio" value=0 onchange="popupRadioChange();"> ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
              </div>
            </div>
          {% endif %}
          <div class="user-name">{{'ì•ˆë…•í•˜ì„¸ìš”! ' + user.nick + 'ë‹˜'}}</div>
          <input id="my-id" type="hidden" value="{{user.id}}">
          <a id="my-profile" href="/profile" class="btn">ë‚´ í”„ë¡œí•„</a>
          <a id="logout" href="/auth/logout" class="btn">ë¡œê·¸ì•„ì›ƒ</a>
          <div display="hidden" class="usernick" data-usernick={{user.nick}}></div>

        {% else %}
         <!-- ì–´ì°¨í”¼ ë¡œê·¸ì¸ì€ êµ¬ê¸€ë¹¼ê³  ë‹¤ ì‚­ì œí• ê±° ì•„ë‹Œê°€? ë¼ë²¨, ë¡œê·¸ì¸í¼, íšŒì›ê°€ì… , ì¹´ì¹´ì˜¤í†¡ ë‹¤ ì‚­ì œì•„ê³  êµ¬ê¸€ë¡œê·¸ì¸ ë²„íŠ¼ë§Œ ë‚¨ê¸°ë©´ ë ë“¯-->
          <div class="login-group">
            <label id="login-text">LOGIN</label>
          </div>
          <form id="login-form" action="/auth/login" method="post">
              <div class="login-group">
                  <label for="email">ì´ë©”ì¼</label>
                  <input id="email" type="email" name="email" required autofocus>
              </div>
              <div class="login-group">
                  <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                  <input id="password" type="password" name="password" required>
              </div>
              <a id="join" href="/join" >íšŒì›ê°€ì…</a>
              <button id="login" type="submit">ë¡œê·¸ì¸</button>
              <a id="kakao" href="/auth/kakao">ì¹´ì¹´ì˜¤í†¡</a>
              <form id="login-google" action="/auth/mail" method="post">
                <input type="hidden" name="scope" value="https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo#email https://www.googleapis.com/auth/plus.me https://www.googleapis.com/auth/tasks https://www-opensocial.googleusercontent.com/api/people https://www.googleapis.com/auth/plus.login" />
                <a id="google" href="/auth/google">êµ¬ê¸€</a>
              </form>
          </form>  
        {% endif %}
  </div>
  <script>
    var modal = document.getElementById('nick-modal');
    var span = document.getElementsByClassName("modal-close")[0];                                          
 
    function popupRadioChange(){
      axios.post('/user/popup');
    }
    function popupClose(){
      modal.style.display = "none";
    }
  </script>
{%endblock%}

{%block rooms%}
  <div class="rooms-block">
    
    {%if user %}
      <button id="createroom" class="createroom-butt unselectable" onclick="location.href='/room'" >Create Room</button><br>
    {%endif%}

    <div class="room-container">
      <!-- 1ë°© = 1room-box -->
      {%for room in rooms%}
        <div class="room-box" data-id="{{room.uuid}}">
          <div>{{room.title}}</div>
          <div>{{room.description}}</div> 
          <div>{{room.participants_num}}/{{room.max}}</div>
          <div>{{'ë¹„ë°€ë°©' if room.password else 'ê³µê°œë°©'}}</div>
          {% if room.img %}
            <div id="room-thumbnail"><img src="/img/{{room.img}}" width="172px"></div>
          {% endif %}
          {% if user %}
            <div>
              <button  data-password="{{'true' if room.password else 'false'}}"
              data-id="{{room.uuid}}" class="room-enter-btn">ì…ì¥</button>
            </div>
          {% endif %}
        </div>
      {%endfor%}
    </div>
    <!-- slide & ë§ˆì§€ë§‰ ë°•ìŠ¤ëŠ” ë°©ìƒì„±ë°•ìŠ¤ë¡œ div calss="room-plus" -->
  </div>
{%endblock%}

{% block content %}
  <div class="content-block">

    <div class="promise-block">
      <div class="promise-title">ì˜¤ëŠ˜ì˜ ë‹¤ì§</div>
      <hr/>
      {% if user %}
        <form id="promise-form" action="/post" method="post" enctype="multipart/form-data">
          <div class="input-group">
            <textarea id="promise-input" name="content" maxlength="100"></textarea>
          </div>
          <div>
            <button id="promise-btn" type="submit" class="btn">ì§¹ì§¹</button>
          </div>
        </form> 
      {% endif %}

      <div class="promises">
        {% for twit in twits %}
          <div class="promise">
            <input type="hidden" value="{{twit.User.id}}" class="promise-user-id">
            <input type="hidden" value="{{twit.id}}" class="promise-id">
            <div class="promise-author">
              {% if twit.User.level_show == 0 %}
                {{twit.User.nick}} level: {{twit.User.level}}
              {%else%}
                {{twit.User.nick}} level: ?
              {%endif%}

              <p>{{twit.msg}}</p>
            </div>
            {%if user and twit.User.id==user.id%}
             <button class="promise-delete" value="{{twit.id}}">ì‚­ì œí•˜ê¸°</button>
            {%endif%}

            {%set likeid=false%}
            {%set likerNum=0%}
            {%for like in twit.Liker%}
              {% if like.id===user.id%}
                {%set likeid=true%}
              {%endif%}
              {%set likerNum=likerNum+1 %}
            {%endfor%}
            {%if user and user.id!=twit.User.id and twit and not likeid%}
              <button class="promise-like">ì¢‹ì•„ìš”</button>
            {% elif user and user.id!=twit.User.id and twit and likeid%}
              <button class="promise-like-cancel">ì¢‹ì•„ìš”ì·¨ì†Œ</button>
            {% endif %}
            <div class="promise-like">{{likerNum}}</div>
          </div>
        {% endfor %}
      </div>

    </div>
    <div class="ranking"> <!-- ë­ì»¤ëŠ” 10ëª…ìœ¼ë¡œ ì œí•œ // 1,2,3ë“± class : rank1, rank2, rank3 -->
      {%set i=0%}
      {%for ranker in rankers%}
        {% if 3>i %}
          <div class="ranker rank{{i+1}}">{{i+1}}ìœ„ : {{ranker.nick}}</div>
          {%set i=i+1%}
        {% else %}
          <div class="ranker">{{i+1}}ìœ„ : {{ranker.nick}}</div>
          {%set i=i+1%}
        {% endif %}
      {%endfor%}
    </div>
    
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <!-- ë­ì»¤ëŠ” 10ëª…ìœ¼ë¡œ ì œí•œ // 1,2,3ë“± class : rank1, rank2, rank3 -->
    <div class="ranking-block"> 
      {%set i=0%}
      {%for ranker in rankers%}
        {% if 3>i %}
          <div class="ranker rank{{i+1}}">{{i+1}}ìœ„ : {{ranker.nick}}</div>
          {%set i=i+1%}
        {% else %}
          <div class="ranker">{{i+1}}ìœ„ : {{ranker.nick}}</div>
          {%set i=i+1%}
        {% endif %}
      {%endfor%}
    </div>

  </div>
    
 <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
 <script>
    document.querySelectorAll('.promise-delete').forEach(function(tag) {
        tag.addEventListener('click', function() {
          const myId = document.querySelector('#my-id');
          const promiseId = tag.parentNode.querySelector('.promise-id').value;
          if (myId) {
            const userId = tag.parentNode.querySelector('.promise-user-id').value;
            if (userId === myId.value) {
              if (confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                axios.delete(`/post/${promiseId}`)
                  .then(() => {
                    location.reload();
                  })
                  .catch((err) => {
                    console.error(err);
                  });
              }
            }
          }
       });
      });
   
      document.querySelectorAll('.promise-like').forEach(function(tag) {
        tag.addEventListener('click', function() {
          const promiseId = tag.parentNode.querySelector('.promise-id').value;
              if (confirm('ì¢‹ì•„ìš”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                axios.post(`/post/${promiseId}/like`)
                  .then(() => {
                    location.reload();
                  })
                  .catch((err) => {
                    console.error(err);
                  });
            }
          });
      });
      document.querySelectorAll('.promise-like-cancel').forEach(function(tag) {
        tag.addEventListener('click', function() {
          const myId = document.querySelector('#my-id');
          const promiseId = tag.parentNode.querySelector('.promise-id').value;
          if (myId) {
            const userId = tag.parentNode.querySelector('.promise-user-id').value;
            if (userId !== myId.value) {
              if (confirm('ì¢‹ì•„ìš” ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                axios.delete(`/post/${promiseId}/like`)
                  .then(() => {
                    location.reload();  
                  })
                  .catch((err) => {
                    console.error(err);
                  });
              }
            }
          }
        });
      });
    </script>
  {% endblock %}

{% block script %}
  <script src="/socket.io/socket.io.js"></script>
  <script src="/public/landing.js"></script>
  <script>
      window.onload = () => {
        if (new URL(location.href).searchParams.get('loginError')) {
          alert(new URL(location.href).searchParams.get('loginError'));
        }
        if (new URL(location.href).searchParams.get('RoomError')) {
          alert(new URL(location.href).searchParams.get('RoomError'));
        }
        if (new URL(location.href).searchParams.get('PwError')) {
          alert(new URL(location.href).searchParams.get('PwError'));
        }
      }
  </script>
{% endblock %}