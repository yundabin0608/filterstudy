
{% extends 'layout.html' %}
{% block login %}
  <div class="login-block">
        {% if user and user.id%}
          {% if user.popup==0 %}
            <div id="nick-modal" class="modal" style="display:block;">
              <div class="modal-content">
                <span class="modal-close" onclick="popupClose();">&times;</span>                                                               
                <p>ğŸ“Œ ë‹‰ë„¤ì„ì€ ë‚´ í”„ë¡œí•„ì—ì„œ ë°”ê¿€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <a href="/profile">ë‚´ í”„ë¡œí•„ê°€ê¸°</a><br>
                <input type="radio" value=0 onchange="popupRadioChange();"> ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
              </div>
            </div>
          {% endif %}
          <div class="user-name">{{'ì•ˆë…•í•˜ì„¸ìš”! ' + user.nick + 'ë‹˜'}}</div>
          <input id="my-id" type="hidden" value="{{user.id}}">
          <a id="my-profile" href="/profile" class="btn">ë‚´ í”„ë¡œí•„</a>
          <a id="logout" href="/auth/logout" class="btn">ë¡œê·¸ì•„ì›ƒ</a>
          <div display="hidden" class="usernick" data-usernick={{user.nick}}></div>

        {% else %}
         <!-- ì–´ì°¨í”¼ ë¡œê·¸ì¸ì€ êµ¬ê¸€ë¹¼ê³  ë‹¤ ì‚­ì œí• ê±° ì•„ë‹Œê°€? ë¼ë²¨, ë¡œê·¸ì¸í¼, íšŒì›ê°€ì… , ì¹´ì¹´ì˜¤í†¡ ë‹¤ ì‚­ì œì•„ê³  êµ¬ê¸€ë¡œê·¸ì¸ ë²„íŠ¼ë§Œ ë‚¨ê¸°ë©´ ë ë“¯-->
          <div class="login-group">
            <label id="login-text">LOGIN</label>
          </div>
          <form id="login-form" action="/auth/login" method="post">
              <div class="login-group">
                  <label for="email">ì´ë©”ì¼</label>
                  <input id="email" type="email" name="email" required autofocus>
              </div>
              <div class="login-group">
                  <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                  <input id="password" type="password" name="password" required>
              </div>
              <a id="join" href="/join" >íšŒì›ê°€ì…</a>
              <button id="login" type="submit">ë¡œê·¸ì¸</button>
              <a id="kakao" href="/auth/kakao">ì¹´ì¹´ì˜¤í†¡</a>
              <form id="login-google" action="/auth/mail" method="post">
                <input type="hidden" name="scope" value="https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo#email https://www.googleapis.com/auth/plus.me https://www.googleapis.com/auth/tasks https://www-opensocial.googleusercontent.com/api/people https://www.googleapis.com/auth/plus.login" />
                <a id="google" href="/auth/google">êµ¬ê¸€</a>
              </form>
          </form>  
        {% endif %}
  </div>
  <script>
    var modal = document.getElementById('nick-modal');
    var span = document.getElementsByClassName("modal-close")[0];                                          
 
    function popupRadioChange(){
      axios.post('/user/popup');
    }
    function popupClose(){
      modal.style.display = "none";
    }
  </script>
{%endblock%}

{%block rooms%}
  <div class="rooms-block">
    <div class="room-container">
      <!-- 1ë°© = 1room-box slideê°€ ì˜†ìœ¼ë¡œ ì›€ì§ì´ë©´ì„œ ì»¨í…Œì´ë„ˆë¶€ë¶„ì—ì„œ ë³´ì´ëŠ”ê²ƒ-->
      <div class="room-slides"> 
        {%for room in rooms%}
          <div class="room-box" data-id="{{room.uuid}}">
            <div style="font-size: 1em; font-weight: 700; margin-top: 5px;">{{room.title}}</div>
            <div style="font-size: 0.9em; margin-top: 3px;">{{room.description}}</div> 
            <div style="font-size: 0.9em; margin-top: 3px">{{room.participants_num}}/{{room.max}}</div>
            <div style="font-size: 0.9em; margin-top: 3px; margin-bottom: 10px">{{'ë¹„ë°€ë°©' if room.password else 'ê³µê°œë°©'}}</div>
            {% if room.img %}
              <div id="room-thumbnail"><img src="/img/{{room.img}}" style="object-fit: scale-down; margin-top: 10px;" width="85%" height="90%"></div>
            {% endif %}
            {% if user %}
              <div>
                <button  data-password="{{'true' if room.password else 'false'}}"
                data-id="{{room.uuid}}" class="room-enter-btn">ì…ì¥</button>
              </div>
            {% endif %}
          </div>
        {%endfor%}
        {%if user %}
          <div class="room-box">
            <button class="plus-butt unselectable" onclick="location.href='/room'" >&#43;</button>
          </div>
        {%endif%}
      </div>
    </div>
    {%if user %}
        <button class="createroom-butt unselectable" onclick="location.href='/room'">ë°© ë§Œë“¤ê¸°</button>
        <form class="rome-code-form" action="/post" method="post" enctype="multipart/form-data">
            <textarea id="room-code-input" name="roomCode" maxlength="30"></textarea>
            <button class="enter-btn" type="submit">ë°© ì…ì¥</button>
        </form> 
    {%endif%}
      <span class="slide-butt slide-left">&#60;</span>
      <span class="slide-butt slide-right">&#62;</span>
  </div>
  <script>
    // ã„´ã…“ë¹„ í¼ì„¼íŠ¸ ë°”ê¿€ê±°ì„ 
    var slides=document.querySelector('.room-slides');
    var slide=document.querySelectorAll('.room-box');
    var currentIndex=0;
    var slideCount=slide.length;
    let leftBtn=document.querySelector('.slide-left');
    let rightBtn=document.querySelector('.slide-right');
    let slidewidth=250; // maybe document.querySelector('.room-box').style.width ë¡œ ê°€ì ¸ì˜¤ë©´ ë ë“¯;
    let slideMargin=65;

    slides.style.width = (slidewidth+slideMargin) * (slideCount+1) - slideMargin + 'px';

    function moveSlide(num){
        slides.style.left= -num * 315 + 'px';
        currentIndex=num;
    }

    rightBtn.addEventListener('click', function(){
        if(currentIndex < slideCount - 3){
            moveSlide(currentIndex+1);
        }
        else{
            moveSlide(0);
        }
    });
    leftBtn.addEventListener('click', function(){
        if(currentIndex > 0){
            moveSlide(currentIndex-1);
        }
        else{
            moveSlide(slideCount-3);
        }
    });
  </script>
{%endblock%}

{% block content %}
  <div class="content-block">
    <a name="content-target"></a>
    <div class="promise-block">
      <div class="promise-container">
        <div class="promise-title">ì˜¤ëŠ˜ì˜ ë‹¤ì§</div>
        <hr style="border-top: 2px dashed white; border-bottom: none; margin: 1% 1%;"/>
        {% if user %}
          <form id="promise-form" action="/post" method="post" enctype="multipart/form-data">
            <div class="promise-input">
              <textarea id="promise-input" name="content" maxlength="100"></textarea>
            </div>
            <button id="promise-btn" type="submit">ë‹¤ì§ğŸ”¥</button>
          </form> 
        {% endif %}

        <div class="p-container">
          {% for posting in twits %}
            <div class="promise">
              <input type="hidden" value="{{posting.User.id}}" class="promise-user-id">
              <input type="hidden" value="{{posting.id}}" class="promise-id">
              <div class="promise-top">
                <input type="hidden" value="{{posting.User.id}}" class="promise-user-id">
                <input type="hidden" value="{{posting.id}}" class="promise-id">
                {% if posting.User.level_show == 0 %}
                  <span class="author">{{posting.User.nick}}</span> <span class="author-level">level: {{posting.User.level}}</span>
                {%else%}
                  <span class="author">{{posting.User.nick}}</span> <span class="author-level">level: ?</span>
                {%endif%}
                
                {%set likeid=false%}
                {%set likerNum=0%}
                {%for like in posting.Liker%}
                  {% if like.id===user.id%}
                    {%set likeid=true%}
                  {%endif%}
                  {%set likerNum=likerNum+1 %}
                {%endfor%}
                {%if user and user.id!=posting.User.id and posting and not likeid%}
                  <button class="p-butt promise-like">ğŸ’™</button>
                {% elif user and user.id!=posting.User.id and posting and likeid%}
                  <button class="p-butt promise-like-cancel">ğŸ’”</button>
                {% endif %}
                <div class="promise-like-num">{{likerNum}}</div>
                {%if user and posting.User.id==user.id%}
                <button class="p-butt promise-delete" value="{{posting.id}}">ğŸ—‘</button>
                {%endif%}
                </div>
                <div class="promise-content">{{posting.msg}}</div> 
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- ë­ì»¤ëŠ” 10ëª…ìœ¼ë¡œ ì œí•œ // 1,2,3ë“± class : rank1, rank2, rank3 -->
    <div class="ranking-block"> 
      <div class="ranking-container">
        {%set i=0%}
        <div class="ranker-container">
        {%for ranker in rankers%}
          {% if 3>i %}
            <span class="ranker3 rank{{i+1}}"><img class="ranker-img" src="/img/rank{{i+1}}.png"><br>{{i+1}}ìœ„ <br> {{ranker.nick}}</span>
            {%if i==2%} </div>{%endif%}
            {%set i=i+1%}
          {% else %}
            <div class="ranker">{{i+1}}ìœ„ : {{ranker.nick}}</div>
            <hr style="border-top: 2px dashed black; border-bottom: none; margin: 0 2%;">
            {%set i=i+1%}
          {% endif %}
        {%endfor%}
      </div>
    </div>

  </div>
    
 <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
 <script>
    document.querySelectorAll('.promise-delete').forEach(function(tag) {
        tag.addEventListener('click', function() {
          const myId = document.querySelector('#my-id');
          const promiseId = tag.parentNode.querySelector('.promise-id').value;
          if (myId) {
            const userId = tag.parentNode.querySelector('.promise-user-id').value;
            if (userId === myId.value) {
              if (confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                axios.delete(`/post/${promiseId}`)
                  .then(() => {
                    location.reload();
                  })
                  .catch((err) => {
                    console.error(err);
                  });
              }
            }
          }
       });
      });
   
      document.querySelectorAll('.promise-like').forEach(function(tag) {
        tag.addEventListener('click', function() {
          const promiseId = tag.parentNode.querySelector('.promise-id').value;
              if (confirm('ì¢‹ì•„ìš”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                axios.post(`/post/${promiseId}/like`)
                  .then(() => {
                    location.reload();
                  })
                  .catch((err) => {
                    console.error(err);
                  });
            }
          });
      });
      document.querySelectorAll('.promise-like-cancel').forEach(function(tag) {
        tag.addEventListener('click', function() {
          const myId = document.querySelector('#my-id');
          const promiseId = tag.parentNode.querySelector('.promise-id').value;
          if (myId) {
            const userId = tag.parentNode.querySelector('.promise-user-id').value;
            if (userId !== myId.value) {
              if (confirm('ì¢‹ì•„ìš” ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                axios.delete(`/post/${promiseId}/like`)
                  .then(() => {
                    location.reload();  
                  })
                  .catch((err) => {
                    console.error(err);
                  });
              }
            }
          }
        });
      });
    </script>
  {% endblock %}

{% block script %}
  <script src="/socket.io/socket.io.js"></script>
  <script src="/public/landing.js"></script>
  <script>
      window.onload = () => {
        if (new URL(location.href).searchParams.get('loginError')) {
          alert(new URL(location.href).searchParams.get('loginError'));
        }
        if (new URL(location.href).searchParams.get('RoomError')) {
          alert(new URL(location.href).searchParams.get('RoomError'));
        }
        if (new URL(location.href).searchParams.get('PwError')) {
          alert(new URL(location.href).searchParams.get('PwError'));
        }
      }
  </script>
{% endblock %}
